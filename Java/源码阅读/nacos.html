<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.67">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/notes/img/logo.svg"><title>xiaoso知识文档</title><meta name="description" content="xiaoso知识文档">
    <link rel="preload" href="/notes/assets/style-ff3ee8e5.css" as="style"><link rel="stylesheet" href="/notes/assets/style-ff3ee8e5.css">
    <link rel="modulepreload" href="/notes/assets/app-9157d7b3.js"><link rel="modulepreload" href="/notes/assets/nacos.html-06448593.js"><link rel="modulepreload" href="/notes/assets/nacos.html-b25dc429.js"><link rel="prefetch" href="/notes/assets/index.html-dcde970e.js" as="script"><link rel="prefetch" href="/notes/assets/github-actions.html-8d6c5aaf.js" as="script"><link rel="prefetch" href="/notes/assets/Arthas.html-e92d2fec.js" as="script"><link rel="prefetch" href="/notes/assets/gin.html-8192643a.js" as="script"><link rel="prefetch" href="/notes/assets/go入门.html-c9a5505d.js" as="script"><link rel="prefetch" href="/notes/assets/docker.html-96283f78.js" as="script"><link rel="prefetch" href="/notes/assets/docker网络.html-63c864db.js" as="script"><link rel="prefetch" href="/notes/assets/helm.html-7bd45791.js" as="script"><link rel="prefetch" href="/notes/assets/k8s权限.html-7d739cff.js" as="script"><link rel="prefetch" href="/notes/assets/k8s环境以及常用工具.html-ee5deee1.js" as="script"><link rel="prefetch" href="/notes/assets/Raft.html-d82c5c1f.js" as="script"><link rel="prefetch" href="/notes/assets/布隆过滤器.html-7e7d5bd8.js" as="script"><link rel="prefetch" href="/notes/assets/设计模式.html-508a3c6f.js" as="script"><link rel="prefetch" href="/notes/assets/MongoDB.html-1c8c2df6.js" as="script"><link rel="prefetch" href="/notes/assets/Redis.html-18940fa2.js" as="script"><link rel="prefetch" href="/notes/assets/k6.html-103ef9b9.js" as="script"><link rel="prefetch" href="/notes/assets/Kafka.html-6074cdf0.js" as="script"><link rel="prefetch" href="/notes/assets/RabbitMQ.html-1590ddd4.js" as="script"><link rel="prefetch" href="/notes/assets/证书.html-63ae040b.js" as="script"><link rel="prefetch" href="/notes/assets/yaml.html-7b7c7b0f.js" as="script"><link rel="prefetch" href="/notes/assets/dubbo3.html-c4435c20.js" as="script"><link rel="prefetch" href="/notes/assets/protobuf.html-ceb5b1ad.js" as="script"><link rel="prefetch" href="/notes/assets/Flink.html-1f4d3a76.js" as="script"><link rel="prefetch" href="/notes/assets/FlinkCDC.html-2c2431c9.js" as="script"><link rel="prefetch" href="/notes/assets/GraalVM.html-24132f71.js" as="script"><link rel="prefetch" href="/notes/assets/EventBus.html-167ed784.js" as="script"><link rel="prefetch" href="/notes/assets/skywalking.html-d880b40b.js" as="script"><link rel="prefetch" href="/notes/assets/SpEL.html-d8e91e94.js" as="script"><link rel="prefetch" href="/notes/assets/Spring-Event.html-ea9d6ee2.js" as="script"><link rel="prefetch" href="/notes/assets/Spring-Retry.html-6d4717b4.js" as="script"><link rel="prefetch" href="/notes/assets/Gateway.html-da1e1aa3.js" as="script"><link rel="prefetch" href="/notes/assets/Nacos.html-6227c303.js" as="script"><link rel="prefetch" href="/notes/assets/OpenFeign.html-f892a7c6.js" as="script"><link rel="prefetch" href="/notes/assets/Ribbon.html-06b82745.js" as="script"><link rel="prefetch" href="/notes/assets/Seata.html-8e78d969.js" as="script"><link rel="prefetch" href="/notes/assets/Sentinel.html-e26e6925.js" as="script"><link rel="prefetch" href="/notes/assets/AsyncTool.html-57bf429a.js" as="script"><link rel="prefetch" href="/notes/assets/LiqiuBase.html-bc22001f.js" as="script"><link rel="prefetch" href="/notes/assets/404.html-f9875e7b.js" as="script"><link rel="prefetch" href="/notes/assets/index.html-411bc993.js" as="script"><link rel="prefetch" href="/notes/assets/github-actions.html-13a96925.js" as="script"><link rel="prefetch" href="/notes/assets/Arthas.html-949c44e6.js" as="script"><link rel="prefetch" href="/notes/assets/gin.html-7491fa2a.js" as="script"><link rel="prefetch" href="/notes/assets/go入门.html-92f9bbc6.js" as="script"><link rel="prefetch" href="/notes/assets/docker.html-ab46d6c0.js" as="script"><link rel="prefetch" href="/notes/assets/docker网络.html-31a5b49a.js" as="script"><link rel="prefetch" href="/notes/assets/helm.html-c2482dde.js" as="script"><link rel="prefetch" href="/notes/assets/k8s权限.html-9ecf2718.js" as="script"><link rel="prefetch" href="/notes/assets/k8s环境以及常用工具.html-8adaf039.js" as="script"><link rel="prefetch" href="/notes/assets/Raft.html-5dfb83bc.js" as="script"><link rel="prefetch" href="/notes/assets/布隆过滤器.html-318c0687.js" as="script"><link rel="prefetch" href="/notes/assets/设计模式.html-0007d33d.js" as="script"><link rel="prefetch" href="/notes/assets/MongoDB.html-03c3fdc6.js" as="script"><link rel="prefetch" href="/notes/assets/Redis.html-7a5a53ea.js" as="script"><link rel="prefetch" href="/notes/assets/k6.html-d092576e.js" as="script"><link rel="prefetch" href="/notes/assets/Kafka.html-f9238a18.js" as="script"><link rel="prefetch" href="/notes/assets/RabbitMQ.html-66eae03b.js" as="script"><link rel="prefetch" href="/notes/assets/证书.html-f2c9d4fd.js" as="script"><link rel="prefetch" href="/notes/assets/yaml.html-9e7be5d4.js" as="script"><link rel="prefetch" href="/notes/assets/dubbo3.html-55deed80.js" as="script"><link rel="prefetch" href="/notes/assets/protobuf.html-09ecd928.js" as="script"><link rel="prefetch" href="/notes/assets/Flink.html-d8086ad9.js" as="script"><link rel="prefetch" href="/notes/assets/FlinkCDC.html-138f08a6.js" as="script"><link rel="prefetch" href="/notes/assets/GraalVM.html-d9d84f50.js" as="script"><link rel="prefetch" href="/notes/assets/EventBus.html-6155808c.js" as="script"><link rel="prefetch" href="/notes/assets/skywalking.html-abf600ac.js" as="script"><link rel="prefetch" href="/notes/assets/SpEL.html-054557e9.js" as="script"><link rel="prefetch" href="/notes/assets/Spring-Event.html-51f7fa91.js" as="script"><link rel="prefetch" href="/notes/assets/Spring-Retry.html-d9356fc9.js" as="script"><link rel="prefetch" href="/notes/assets/Gateway.html-78a4bf91.js" as="script"><link rel="prefetch" href="/notes/assets/Nacos.html-91ecab5e.js" as="script"><link rel="prefetch" href="/notes/assets/OpenFeign.html-05fedffe.js" as="script"><link rel="prefetch" href="/notes/assets/Ribbon.html-06cf9b87.js" as="script"><link rel="prefetch" href="/notes/assets/Seata.html-73805653.js" as="script"><link rel="prefetch" href="/notes/assets/Sentinel.html-7125ac2b.js" as="script"><link rel="prefetch" href="/notes/assets/AsyncTool.html-971fc0d7.js" as="script"><link rel="prefetch" href="/notes/assets/LiqiuBase.html-6cf07e16.js" as="script"><link rel="prefetch" href="/notes/assets/404.html-e5bfb25f.js" as="script"><link rel="prefetch" href="/notes/assets/mermaid.core-d502af59.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/notes/" class=""><!----><span class="site-name">xiaoso知识文档</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/notes/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="CI&amp;CD"><span class="title">CI&amp;CD</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="CI&amp;CD"><span class="title">CI&amp;CD</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/CI&amp;CD/github-actions.md" class="" aria-label="GitHub Actions"><!--[--><!--]--> GitHub Actions <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="容器云"><span class="title">容器云</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="容器云"><span class="title">容器云</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/云/docker.md" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="网络"><span class="title">网络</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="网络"><span class="title">网络</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/网络/证书.md" class="" aria-label="证书和HTTPS"><!--[--><!--]--> 证书和HTTPS <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Spring"><span class="title">Spring</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Spring"><span class="title">Spring</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/Java/Spring/SpEL.md" class="" aria-label="SpEL表达式"><!--[--><!--]--> SpEL表达式 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/Spring/Spring-Event.md" class="" aria-label="event"><!--[--><!--]--> event <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="微服务"><span class="title">微服务</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="微服务"><span class="title">微服务</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/Java/SpringCloud/Nacos.md" class="" aria-label="注册配置中心-Nacos"><!--[--><!--]--> 注册配置中心-Nacos <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/SpringCloud/OpenFeign.md" class="" aria-label="声明式HTTP客户端-OpenFeign"><!--[--><!--]--> 声明式HTTP客户端-OpenFeign <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/SpringCloud/Ribbon.md" class="" aria-label="客户端负载均衡-Ribbon"><!--[--><!--]--> 客户端负载均衡-Ribbon <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/SpringCloud/Seata.md" class="" aria-label="分布式事务-Seata"><!--[--><!--]--> 分布式事务-Seata <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/SpringCloud/Sentinel.md" class="" aria-label="流控熔断-Sentinel"><!--[--><!--]--> 流控熔断-Sentinel <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/SpringCloud/Gateway.md" class="" aria-label="网关-Gateway"><!--[--><!--]--> 网关-Gateway <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/SkyWalking/skywalking.md" class="" aria-label="APM-SkyWalking"><!--[--><!--]--> APM-SkyWalking <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="常用组件"><span class="title">常用组件</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="常用组件"><span class="title">常用组件</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/Java/Dubbo/dubbo3.md" class="" aria-label="Dubbo3"><!--[--><!--]--> Dubbo3 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/Flink/Flink.md" class="" aria-label="Flink"><!--[--><!--]--> Flink <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/Flink/FlinkCDC.md" class="" aria-label="FlinkCDC"><!--[--><!--]--> FlinkCDC <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/GraalVM/GraalVM.md" class="" aria-label="GraalVM"><!--[--><!--]--> GraalVM <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/测试/k6.md" class="" aria-label="k6-压测"><!--[--><!--]--> k6-压测 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/数据库/MongoDB.md" class="" aria-label="MongoDB"><!--[--><!--]--> MongoDB <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/其他工具/AsyncTool.md" class="" aria-label="AsyncTool"><!--[--><!--]--> AsyncTool <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="golang"><span class="title">golang</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="golang"><span class="title">golang</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/go/go入门.md" class="" aria-label="golang入门"><!--[--><!--]--> golang入门 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="常用知识"><span class="title">常用知识</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="常用知识"><span class="title">常用知识</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/常用知识/设计模式.md" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/常用知识/布隆过滤器.md" class="" aria-label="布隆过滤器"><!--[--><!--]--> 布隆过滤器 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/通用/yaml.md" class="" aria-label="yaml"><!--[--><!--]--> yaml <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/Dubbo/protobuf.md" class="" aria-label="protobuf"><!--[--><!--]--> protobuf <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="常用工具"><span class="title">常用工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="常用工具"><span class="title">常用工具</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://cyc2018.github.io/Text-Typesetting/" rel="noopener noreferrer" target="_blank" aria-label="中英文排版工具"><!--[--><!--]--> 中英文排版工具 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://ctool.dev/" rel="noopener noreferrer" target="_blank" aria-label="编程常用工具箱 ctool"><!--[--><!--]--> 编程常用工具箱 ctool <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/xiaoso456/notes" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/notes/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="CI&amp;CD"><span class="title">CI&amp;CD</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="CI&amp;CD"><span class="title">CI&amp;CD</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/CI&amp;CD/github-actions.md" class="" aria-label="GitHub Actions"><!--[--><!--]--> GitHub Actions <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="容器云"><span class="title">容器云</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="容器云"><span class="title">容器云</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/云/docker.md" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="网络"><span class="title">网络</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="网络"><span class="title">网络</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/网络/证书.md" class="" aria-label="证书和HTTPS"><!--[--><!--]--> 证书和HTTPS <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Spring"><span class="title">Spring</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Spring"><span class="title">Spring</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/Java/Spring/SpEL.md" class="" aria-label="SpEL表达式"><!--[--><!--]--> SpEL表达式 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/Spring/Spring-Event.md" class="" aria-label="event"><!--[--><!--]--> event <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="微服务"><span class="title">微服务</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="微服务"><span class="title">微服务</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/Java/SpringCloud/Nacos.md" class="" aria-label="注册配置中心-Nacos"><!--[--><!--]--> 注册配置中心-Nacos <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/SpringCloud/OpenFeign.md" class="" aria-label="声明式HTTP客户端-OpenFeign"><!--[--><!--]--> 声明式HTTP客户端-OpenFeign <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/SpringCloud/Ribbon.md" class="" aria-label="客户端负载均衡-Ribbon"><!--[--><!--]--> 客户端负载均衡-Ribbon <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/SpringCloud/Seata.md" class="" aria-label="分布式事务-Seata"><!--[--><!--]--> 分布式事务-Seata <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/SpringCloud/Sentinel.md" class="" aria-label="流控熔断-Sentinel"><!--[--><!--]--> 流控熔断-Sentinel <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/SpringCloud/Gateway.md" class="" aria-label="网关-Gateway"><!--[--><!--]--> 网关-Gateway <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/SkyWalking/skywalking.md" class="" aria-label="APM-SkyWalking"><!--[--><!--]--> APM-SkyWalking <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="常用组件"><span class="title">常用组件</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="常用组件"><span class="title">常用组件</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/Java/Dubbo/dubbo3.md" class="" aria-label="Dubbo3"><!--[--><!--]--> Dubbo3 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/Flink/Flink.md" class="" aria-label="Flink"><!--[--><!--]--> Flink <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/Flink/FlinkCDC.md" class="" aria-label="FlinkCDC"><!--[--><!--]--> FlinkCDC <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/GraalVM/GraalVM.md" class="" aria-label="GraalVM"><!--[--><!--]--> GraalVM <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/测试/k6.md" class="" aria-label="k6-压测"><!--[--><!--]--> k6-压测 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/数据库/MongoDB.md" class="" aria-label="MongoDB"><!--[--><!--]--> MongoDB <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/其他工具/AsyncTool.md" class="" aria-label="AsyncTool"><!--[--><!--]--> AsyncTool <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="golang"><span class="title">golang</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="golang"><span class="title">golang</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/go/go入门.md" class="" aria-label="golang入门"><!--[--><!--]--> golang入门 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="常用知识"><span class="title">常用知识</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="常用知识"><span class="title">常用知识</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/notes/常用知识/设计模式.md" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/常用知识/布隆过滤器.md" class="" aria-label="布隆过滤器"><!--[--><!--]--> 布隆过滤器 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/通用/yaml.md" class="" aria-label="yaml"><!--[--><!--]--> yaml <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/notes/Java/Dubbo/protobuf.md" class="" aria-label="protobuf"><!--[--><!--]--> protobuf <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="常用工具"><span class="title">常用工具</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="常用工具"><span class="title">常用工具</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://cyc2018.github.io/Text-Typesetting/" rel="noopener noreferrer" target="_blank" aria-label="中英文排版工具"><!--[--><!--]--> 中英文排版工具 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://ctool.dev/" rel="noopener noreferrer" target="_blank" aria-label="编程常用工具箱 ctool"><!--[--><!--]--> 编程常用工具箱 ctool <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/xiaoso456/notes" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading"> <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#简介" class="router-link-active router-link-exact-active sidebar-item" aria-label="简介"><!--[--><!--]--> 简介 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#源码启动" class="router-link-active router-link-exact-active sidebar-item" aria-label="源码启动"><!--[--><!--]--> 源码启动 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#架构" class="router-link-active router-link-exact-active sidebar-item" aria-label="架构"><!--[--><!--]--> 架构 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#隔离模型" class="router-link-active router-link-exact-active sidebar-item" aria-label="隔离模型"><!--[--><!--]--> 隔离模型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#配置中心" class="router-link-active router-link-exact-active sidebar-item" aria-label="配置中心"><!--[--><!--]--> 配置中心 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#长轮询的实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="长轮询的实现"><!--[--><!--]--> 长轮询的实现 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#用户权限模块" class="router-link-active router-link-exact-active sidebar-item" aria-label="用户权限模块"><!--[--><!--]--> 用户权限模块 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#结构" class="router-link-active router-link-exact-active sidebar-item" aria-label="结构"><!--[--><!--]--> 结构 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#存储模块" class="router-link-active router-link-exact-active sidebar-item" aria-label="存储模块"><!--[--><!--]--> 存储模块 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#接口设计" class="router-link-active router-link-exact-active sidebar-item" aria-label="接口设计"><!--[--><!--]--> 接口设计 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#file-实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="File 实现"><!--[--><!--]--> File 实现 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#memory-实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="Memory 实现"><!--[--><!--]--> Memory 实现 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#设计模式" class="router-link-active router-link-exact-active sidebar-item" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#服务注册发现" class="router-link-active router-link-exact-active sidebar-item" aria-label="服务注册发现"><!--[--><!--]--> 服务注册发现 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#模型" class="router-link-active router-link-exact-active sidebar-item" aria-label="模型"><!--[--><!--]--> 模型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#代码模型" class="router-link-active router-link-exact-active sidebar-item" aria-label="代码模型"><!--[--><!--]--> 代码模型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#rest接口" class="router-link-active router-link-exact-active sidebar-item" aria-label="Rest接口"><!--[--><!--]--> Rest接口 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#分布式" class="router-link-active router-link-exact-active sidebar-item" aria-label="分布式"><!--[--><!--]--> 分布式 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#一致性协议" class="router-link-active router-link-exact-active sidebar-item" aria-label="一致性协议"><!--[--><!--]--> 一致性协议 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#todo-distro" class="router-link-active router-link-exact-active sidebar-item" aria-label="todo：distro"><!--[--><!--]--> todo：distro <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/notes/Java/%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/nacos.html#参考" class="router-link-active router-link-exact-active sidebar-item" aria-label="参考"><!--[--><!--]--> 参考 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h2 id="简介" tabindex="-1"><a class="header-anchor" href="#简介" aria-hidden="true">#</a> 简介</h2><p>nacos1.4.6 源码</p><h2 id="源码启动" tabindex="-1"><a class="header-anchor" href="#源码启动" aria-hidden="true">#</a> 源码启动</h2><p>下载 nacos 1.4.6 源码</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">git</span> clone <span class="token parameter variable">-b</span> <span class="token number">1.4</span>.6 https://github.com/alibaba/nacos.git
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>源码启动入口为 <code>nacos-console</code> 模块，入口类为 <code>com.alibaba.nacos.Nacos.java</code></p><p>源码启动前，需要先编译 <code>consistency</code> 模块，把 <code>.proto</code> 编译为 Java 类，再启动。</p><p>调试环境添加启动参数 <code>-Dnacos.standalone=true</code>，使用内嵌数据库</p><h2 id="架构" tabindex="-1"><a class="header-anchor" href="#架构" aria-hidden="true">#</a> 架构</h2><p><img src="/notes/assets/1561217892717-1418fb9b-7faa-4324-87b9-f1740329f564-c1b39f34.jpeg" alt="nacos_arch.jpg"></p><p>address：</p><p>api：</p><p>auth：认证权限模块</p><p>client：</p><p>cmdb：解决元数据存储，与三方 CMDB 系统对接问题</p><p>common：</p><p>config：</p><p>consistency：</p><p>console：</p><p>console-ui：控制台前端</p><p>core：核心模块</p><p>distribution：</p><p>doc：</p><p>exmaple：</p><p>istio：</p><p>naming：</p><p>sys：</p><p>test：</p><h2 id="隔离模型" tabindex="-1"><a class="header-anchor" href="#隔离模型" aria-hidden="true">#</a> 隔离模型</h2><p>nacos采用了company，namespace，group，service四级隔离模型</p><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div class="loading-icon-wrapper mermaid-loading" style="display:flex;align-items:center;justify-content:center;height:96px;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><h2 id="配置中心" tabindex="-1"><a class="header-anchor" href="#配置中心" aria-hidden="true">#</a> 配置中心</h2><h3 id="长轮询的实现" tabindex="-1"><a class="header-anchor" href="#长轮询的实现" aria-hidden="true">#</a> 长轮询的实现</h3><p>nacos 1.x 中采用长轮询实现监听配置变化</p><p>url：<code>/nacos/v1/cs/configs/listener</code></p><p>长轮询监听配置的方法如下，当前方法不会返回数据，而是调用长轮询方法，当数据有变化时在 response 里写数据返回</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/listener&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Secured</span><span class="token punctuation">(</span>action <span class="token operator">=</span> <span class="token class-name">ActionTypes</span><span class="token punctuation">.</span><span class="token constant">READ</span><span class="token punctuation">,</span> parser <span class="token operator">=</span> <span class="token class-name">ConfigResourceParser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取监听配置的字符串</span>
    <span class="token class-name">String</span> probeModify <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">&quot;Listening-Configs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>probeModify<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;invalid probeModify&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    probeModify <span class="token operator">=</span> <span class="token class-name">URLDecoder</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>probeModify<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ENCODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> clientMd5Map<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        clientMd5Map <span class="token operator">=</span> <span class="token class-name">MD5Util</span><span class="token punctuation">.</span><span class="token function">getClientMd5Map</span><span class="token punctuation">(</span>probeModify<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;invalid probeModify&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// do long-polling</span>
    inner<span class="token punctuation">.</span><span class="token function">doPollingConfig</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">,</span> probeModify<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>   <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">doPollingConfig</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> clientMd5Map<span class="token punctuation">,</span> <span class="token keyword">int</span> probeRequestSize<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        
        <span class="token comment">// Long polling.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">LongPollingService</span><span class="token punctuation">.</span><span class="token function">isSupportLongPolling</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            longPollingService<span class="token punctuation">.</span><span class="token function">addLongPollingClient</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">,</span> probeRequestSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">HttpServletResponse</span><span class="token punctuation">.</span><span class="token constant">SC_OK</span> <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 不支持长轮询，直接返回</span>
        <span class="token comment">// Compatible with short polling logic.</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> changedGroups <span class="token operator">=</span> <span class="token class-name">MD5Util</span><span class="token punctuation">.</span><span class="token function">compareMd5</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Compatible with short polling result.</span>
        <span class="token class-name">String</span> oldResult <span class="token operator">=</span> <span class="token class-name">MD5Util</span><span class="token punctuation">.</span><span class="token function">compareMd5OldResult</span><span class="token punctuation">(</span>changedGroups<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> newResult <span class="token operator">=</span> <span class="token class-name">MD5Util</span><span class="token punctuation">.</span><span class="token function">compareMd5ResultString</span><span class="token punctuation">(</span>changedGroups<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">String</span> version <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CLIENT_VERSION_HEADER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            version <span class="token operator">=</span> <span class="token string">&quot;2.0.0&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">int</span> versionNum <span class="token operator">=</span> <span class="token class-name">Protocol</span><span class="token punctuation">.</span><span class="token function">getVersionNumber</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Before 2.0.4 version, return value is put into header.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>versionNum <span class="token operator">&lt;</span> <span class="token constant">START_LONG_POLLING_VERSION_NUM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">PROBE_MODIFY_RESPONSE</span><span class="token punctuation">,</span> oldResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">PROBE_MODIFY_RESPONSE_NEW</span><span class="token punctuation">,</span> newResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            request<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">,</span> newResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">AUTH</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;new content:&quot;</span> <span class="token operator">+</span> newResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Disable cache.</span>
        response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Pragma&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;no-cache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setDateHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Expires&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Cache-Control&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;no-cache,no-store&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">.</span><span class="token constant">SC_OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">HttpServletResponse</span><span class="token punctuation">.</span><span class="token constant">SC_OK</span> <span class="token operator">+</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面是长轮询实现，首先检测配置是否发生了变化，如果发生了变化，直接返回。否则开启长轮询异步返回</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * Add LongPollingClient.
     *
     * <span class="token keyword">@param</span> <span class="token parameter">req</span>              HttpServletRequest.
     * <span class="token keyword">@param</span> <span class="token parameter">rsp</span>              HttpServletResponse.
     * <span class="token keyword">@param</span> <span class="token parameter">clientMd5Map</span>     clientMd5Map.
     * <span class="token keyword">@param</span> <span class="token parameter">probeRequestSize</span> probeRequestSize.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addLongPollingClient</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> req<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> rsp<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> clientMd5Map<span class="token punctuation">,</span>
            <span class="token keyword">int</span> probeRequestSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        <span class="token class-name">String</span> str <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">LongPollingService</span><span class="token punctuation">.</span><span class="token constant">LONG_POLLING_HEADER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> noHangUpFlag <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">LongPollingService</span><span class="token punctuation">.</span><span class="token constant">LONG_POLLING_NO_HANG_UP_HEADER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> appName <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">RequestUtil</span><span class="token punctuation">.</span><span class="token constant">CLIENT_APPNAME_HEADER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> tag <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Vipserver-Tag&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> delayTime <span class="token operator">=</span> <span class="token class-name">SwitchService</span><span class="token punctuation">.</span><span class="token function">getSwitchInteger</span><span class="token punctuation">(</span><span class="token class-name">SwitchService</span><span class="token punctuation">.</span><span class="token constant">FIXED_DELAY_TIME</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Add delay time for LoadBalance, and one response is returned 500 ms in advance to avoid client timeout.</span>
        <span class="token keyword">long</span> timeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">-</span> delayTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFixedPolling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token function">getFixedPollingInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Do nothing but set fix polling timeout.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> changedGroups <span class="token operator">=</span> <span class="token class-name">MD5Util</span><span class="token punctuation">.</span><span class="token function">compareMd5</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> rsp<span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>changedGroups<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">generateResponse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> rsp<span class="token punctuation">,</span> changedGroups<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">LogUtil</span><span class="token punctuation">.</span><span class="token constant">CLIENT_LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}|{}|{}|{}|{}|{}|{}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">,</span> <span class="token string">&quot;instant&quot;</span><span class="token punctuation">,</span>
                        <span class="token class-name">RequestUtil</span><span class="token punctuation">.</span><span class="token function">getRemoteIp</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;polling&quot;</span><span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> probeRequestSize<span class="token punctuation">,</span>
                        changedGroups<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>noHangUpFlag <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> noHangUpFlag<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token constant">TRUE_STR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">LogUtil</span><span class="token punctuation">.</span><span class="token constant">CLIENT_LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}|{}|{}|{}|{}|{}|{}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">,</span> <span class="token string">&quot;nohangup&quot;</span><span class="token punctuation">,</span>
                        <span class="token class-name">RequestUtil</span><span class="token punctuation">.</span><span class="token function">getRemoteIp</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;polling&quot;</span><span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> probeRequestSize<span class="token punctuation">,</span>
                        changedGroups<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> ip <span class="token operator">=</span> <span class="token class-name">RequestUtil</span><span class="token punctuation">.</span><span class="token function">getRemoteIp</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Must be called by http thread, or send response.</span>
        <span class="token keyword">final</span> <span class="token class-name">AsyncContext</span> asyncContext <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">startAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// AsyncContext.setTimeout() is incorrect, Control by oneself</span>
        asyncContext<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">ConfigExecutor</span><span class="token punctuation">.</span><span class="token function">executeLongPolling</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">ClientLongPolling</span><span class="token punctuation">(</span>asyncContext<span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> probeRequestSize<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> appName<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>新建了一个clientLongPolling的任务，作用是</p><ol><li>新建了一个任务，把当前任务放到了队列<code>allSubs</code>里</li><li>延迟29.5s执行一个任务：尝试删除队列里当前任务 <ul><li>如果删除失败，说明任务已经被执行</li><li>如果删除成功，说明任务还未被执行，检查一下配置是否发生了变化，如果变化，推送变化数据，如果没变化，推送null数据</li></ul></li></ol><p>这个队列<code>allSubs</code>是公用队列，如果配置发生了变化，会触发一个事件，并调用相应队列的方法，返回结果</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">class</span> <span class="token class-name">ClientLongPolling</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
        
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            asyncTimeoutFuture <span class="token operator">=</span> <span class="token class-name">ConfigExecutor</span><span class="token punctuation">.</span><span class="token function">scheduleLongPolling</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token function">getRetainIps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ClientLongPolling</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>ip<span class="token punctuation">,</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        
                        <span class="token comment">// Delete subsciber&#39;s relations.</span>
                        <span class="token keyword">boolean</span> removeFlag <span class="token operator">=</span> allSubs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">ClientLongPolling</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>removeFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFixedPolling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token class-name">LogUtil</span><span class="token punctuation">.</span><span class="token constant">CLIENT_LOG</span>
                                        <span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}|{}|{}|{}|{}|{}&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> createTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;fix&quot;</span><span class="token punctuation">,</span>
                                                <span class="token class-name">RequestUtil</span><span class="token punctuation">.</span><span class="token function">getRemoteIp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> asyncContext<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                <span class="token string">&quot;polling&quot;</span><span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> probeRequestSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> changedGroups <span class="token operator">=</span> <span class="token class-name">MD5Util</span>
                                        <span class="token punctuation">.</span><span class="token function">compareMd5</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> asyncContext<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> asyncContext<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>changedGroups<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token function">sendResponse</span><span class="token punctuation">(</span>changedGroups<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                    <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                <span class="token class-name">LogUtil</span><span class="token punctuation">.</span><span class="token constant">CLIENT_LOG</span>
                                        <span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}|{}|{}|{}|{}|{}&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> createTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;timeout&quot;</span><span class="token punctuation">,</span>
                                                <span class="token class-name">RequestUtil</span><span class="token punctuation">.</span><span class="token function">getRemoteIp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> asyncContext<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                <span class="token string">&quot;polling&quot;</span><span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> probeRequestSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token class-name">LogUtil</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_LOG</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;client subsciber&#39;s relations delete fail.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">LogUtil</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_LOG</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;long polling error:&quot;</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    
                <span class="token punctuation">}</span>
                
            <span class="token punctuation">}</span><span class="token punctuation">,</span> timeoutTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            allSubs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="用户权限模块" tabindex="-1"><a class="header-anchor" href="#用户权限模块" aria-hidden="true">#</a> 用户权限模块</h2><p>nacos的auth模块被设计为轻量级auth，只适用于微服务内部使用</p><p>:::info</p><ul><li>Nacos是一个内部微服务组件，需要在可信的内部网络中运行，不可暴露在公网环境，防止带来安全风险。</li><li>Nacos提供简单的鉴权实现，为防止业务错用的弱鉴权体系，不是防止恶意攻击的强鉴权体系。</li><li>如果运行在不可信的网络环境或者有强鉴权诉求，请参考官方简单实现做替换增强。</li></ul><p>:::</p><p>Nacos用户权限主要有两个管理模块：</p><ul><li><p>用户管理：解决用户管理，登录，SSO 等问题</p></li><li><p>权限管理：解决身份识别，访问控制，角色管理等问题</p></li></ul><h3 id="结构" tabindex="-1"><a class="header-anchor" href="#结构" aria-hidden="true">#</a> 结构</h3><p>Auth模块：主要定义权限相关的类（ActionTypes），权限模型（Permission、Resource、User），以及相关注解，比较简单</p><p>Console模块：主要提供业务层Rest接口，无非内嵌数据库或者外部数据库的增删改查</p><h2 id="存储模块" tabindex="-1"><a class="header-anchor" href="#存储模块" aria-hidden="true">#</a> 存储模块</h2><p>nacos存储模块主要提供kv存储服务，接口较为简单，实现也只提供了File和Memory两种简单实现，RocksDB没有实现</p><h3 id="接口设计" tabindex="-1"><a class="header-anchor" href="#接口设计" aria-hidden="true">#</a> 接口设计</h3><p>首先看到 core模块 <code>com.alibaba.nacos.core.storage.kv.KvStorage</code> 接口，提供了围绕key的增删改查接口以及三个实现</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">KvStorage</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">enum</span> <span class="token class-name">KvType</span> <span class="token punctuation">{</span>
        <span class="token class-name">File</span><span class="token punctuation">,</span>
        <span class="token class-name">Memory</span><span class="token punctuation">,</span>
        <span class="token class-name">RocksDB</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KvStorageException</span><span class="token punctuation">;</span>
    
    <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">batchGet</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> keys<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KvStorageException</span><span class="token punctuation">;</span>
    
    <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KvStorageException</span><span class="token punctuation">;</span>
    
    <span class="token keyword">void</span> <span class="token function">batchPut</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> keys<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> values<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KvStorageException</span><span class="token punctuation">;</span>
    
    <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KvStorageException</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">batchDelete</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> keys<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KvStorageException</span><span class="token punctuation">;</span>
    
    <span class="token keyword">void</span> <span class="token function">doSnapshot</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> backupPath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KvStorageException</span><span class="token punctuation">;</span>
    
    <span class="token keyword">void</span> <span class="token function">snapshotLoad</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KvStorageException</span><span class="token punctuation">;</span>
    
    <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token function">allKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KvStorageException</span><span class="token punctuation">;</span>
    
    <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="file-实现" tabindex="-1"><a class="header-anchor" href="#file-实现" aria-hidden="true">#</a> File 实现</h3><p>File实现比较简单，以其中的构造方法和get方法作说明</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>     <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> baseDir<span class="token punctuation">;</span>
    
    <span class="token doc-comment comment">/**
     * Ensure that a consistent view exists when implementing file copies.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>ReadLock</span> readLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantReadWriteLock<span class="token punctuation">.</span>WriteLock</span> writeLock <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token keyword">public</span> <span class="token class-name">FileKvStorage</span><span class="token punctuation">(</span><span class="token class-name">String</span> baseDir<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>baseDir <span class="token operator">=</span> baseDir<span class="token punctuation">;</span>
        <span class="token class-name">DiskUtils</span><span class="token punctuation">.</span><span class="token function">forceMkdir</span><span class="token punctuation">(</span>baseDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KvStorageException</span> <span class="token punctuation">{</span>
        readLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>baseDir<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">DiskUtils</span><span class="token punctuation">.</span><span class="token function">readFileBytes</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            readLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建Java进程级读写锁，粒度为目录级，也就是说读操作互不影响，写操作会暂停其他读写。但比较令人费解的是，put 系列方法也是使用读锁，只有doSnapshot做整个目录快照时，才使用写锁。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KvStorageException</span> <span class="token punctuation">{</span>
        readLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>baseDir<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">DiskUtils</span><span class="token punctuation">.</span><span class="token function">touch</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">DiskUtils</span><span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KvStorageException</span><span class="token punctuation">(</span><span class="token class-name">ErrorCode<span class="token punctuation">.</span>KVStorageWriteError</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            readLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="memory-实现" tabindex="-1"><a class="header-anchor" href="#memory-实现" aria-hidden="true">#</a> Memory 实现</h3><p>Memory实现更为简单，围绕线程安全的 ConcurrentSkipListMap （并发读写的有序map）进行增删改查</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">Key</span><span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> storage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentSkipListMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="设计模式" tabindex="-1"><a class="header-anchor" href="#设计模式" aria-hidden="true">#</a> 设计模式</h3><p>StorageFactory.java 使用了工厂模式</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">KvStorage</span> <span class="token function">createKvStorage</span><span class="token punctuation">(</span><span class="token class-name">KvStorage<span class="token punctuation">.</span>KvType</span> type<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> label<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> baseDir<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token class-name">File</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FileKvStorage</span><span class="token punctuation">(</span>baseDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">Memory</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MemoryKvStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token class-name">RocksDB</span><span class="token operator">:</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;this kv type : [&quot;</span> <span class="token operator">+</span> type<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;] not support&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="服务注册发现" tabindex="-1"><a class="header-anchor" href="#服务注册发现" aria-hidden="true">#</a> 服务注册发现</h2><p>服务注册发现功能是 Nacos 核心，主要位于 Naming 模块和apis模块</p><h3 id="模型" tabindex="-1"><a class="header-anchor" href="#模型" aria-hidden="true">#</a> 模型</h3><!--[--><div class="mermaid-actions"><button class="preview-button" title="preview"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1316 1024" fill="currentColor"><path d="M658.286 0C415.89 0 0 297.106 0 512c0 214.82 415.89 512 658.286 512 242.322 0 658.285-294.839 658.285-512S900.608 0 658.286 0zm0 877.714c-161.573 0-512-221.769-512-365.714 0-144.018 350.427-365.714 512-365.714 161.572 0 512 217.16 512 365.714s-350.428 365.714-512 365.714z"/><path d="M658.286 292.571a219.429 219.429 0 1 0 0 438.858 219.429 219.429 0 0 0 0-438.858zm0 292.572a73.143 73.143 0 1 1 0-146.286 73.143 73.143 0 0 1 0 146.286z"/></svg></button><button class="download-button" title="download"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" fill="currentColor"><path d="M828.976 894.125H190.189c-70.55 0-127.754-57.185-127.754-127.753V606.674c0-17.634 14.31-31.933 31.933-31.933h63.889c17.634 0 31.932 14.299 31.932 31.933v95.822c0 35.282 28.596 63.877 63.877 63.877h511.033c35.281 0 63.877-28.595 63.877-63.877v-95.822c0-17.634 14.298-31.933 31.943-31.933h63.878c17.635 0 31.933 14.299 31.933 31.933v159.7c0 70.566-57.191 127.751-127.754 127.751zM249.939 267.51c12.921-12.92 33.885-12.92 46.807 0l148.97 148.972V94.893c0-17.634 14.302-31.947 31.934-31.947h63.876c17.638 0 31.946 14.313 31.946 31.947v321.589l148.97-148.972c12.922-12.92 33.876-12.92 46.797 0l46.814 46.818c12.922 12.922 12.922 33.874 0 46.807L552.261 624.93c-1.14 1.138-21.664 13.684-42.315 13.693-20.877.01-41.88-12.542-43.021-13.693L203.122 361.135c-12.923-12.934-12.923-33.885 0-46.807l46.817-46.818z"/></svg></button></div><div class="mermaid-wrapper"><div class="loading-icon-wrapper mermaid-loading" style="display:flex;align-items:center;justify-content:center;height:96px;"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" preserveAspectRatio="xMidYMid" viewBox="25 25 50 50"><animateTransform attributeName="transform" type="rotate" dur="2s" keyTimes="0;1" repeatCount="indefinite" values="0;360"></animateTransform><circle cx="50" cy="50" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round"><animate attributeName="stroke-dasharray" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="1,200;90,200;1,200"></animate><animate attributeName="stroke-dashoffset" dur="1.5s" keyTimes="0;0.5;1" repeatCount="indefinite" values="0;-35px;-125px"></animate></circle></svg></div></div><!--]--><p>一个能提供服务的实例所属模型如上图</p><p>nacos 的 group没有实体，其实group是service的一部分，以service前缀来区分group，例如servicename为<code>DEFAULT_GROUP@@nacos.test.3</code>，group为<code>DEFAULT_GROUP</code>，service为<code>nacos.test.3</code></p><h3 id="代码模型" tabindex="-1"><a class="header-anchor" href="#代码模型" aria-hidden="true">#</a> 代码模型</h3><p>com.alibaba.nacos.api.naming.pojo.Instance</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@JsonInclude</span><span class="token punctuation">(</span><span class="token class-name">Include</span><span class="token punctuation">.</span><span class="token constant">NON_NULL</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Instance</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">742906310567291979L</span><span class="token punctuation">;</span>
    <span class="token comment">//实例的唯一id</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> instanceId<span class="token punctuation">;</span>
    <span class="token comment">//实例IP</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> ip<span class="token punctuation">;</span>
    <span class="token comment">//实例端口</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>
    <span class="token comment">//实例权重</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> weight <span class="token operator">=</span> <span class="token number">1.0D</span><span class="token punctuation">;</span> 
    <span class="token comment">//实例健康状态</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> healthy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">//实例是否可接收请求</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">//实例是否为临时实例</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> ephemeral <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">//实例所属集群信息</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> clusterName<span class="token punctuation">;</span>
    <span class="token comment">//实例所属服务信息</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serviceName<span class="token punctuation">;</span>
    <span class="token comment">//用户扩展属性</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> metadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>com.alibaba.nacos.api.naming.pojo.Cluster</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;checkstyle:abbreviationaswordinname&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Cluster</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token comment">//所属服务名称</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serviceName<span class="token punctuation">;</span>

    <span class="token comment">//集群名称</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token comment">//集群健康检查配置</span>
    <span class="token keyword">private</span> <span class="token class-name">AbstractHealthChecker</span> healthChecker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tcp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token comment">//集群实例默认注册端口</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> defaultPort <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>

    <span class="token comment">//集群实例默认健康检查端口</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> defaultCheckPort <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>

    <span class="token comment">//是否使用实例端口做健康检查</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> useIPPort4Check <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">//元数据</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> metadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>com.alibaba.nacos.api.naming.pojo.Service</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Service</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3470985546826874460L</span><span class="token punctuation">;</span>
    <span class="token comment">// 服务名</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token comment">// 保护阈值</span>
    <span class="token keyword">private</span> <span class="token keyword">float</span> protectThreshold <span class="token operator">=</span> <span class="token number">0.0F</span><span class="token punctuation">;</span>
    <span class="token comment">// 应用名</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appName<span class="token punctuation">;</span>
   	<span class="token comment">// group 名</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> groupName<span class="token punctuation">;</span>
    <span class="token comment">// 元数据</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> metadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>存储 namespace，group，service 映射</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * Map(namespace, Map(group::serviceName, Service)).
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Service</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> serviceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意这个map虽然是多线程安全的map，但并不能保证相关操作的原子性，创建服务时，如果不存在namespace需要加锁。</p><p>:::info</p><p>putServiceLock 可以不需要用 volatile 修饰，因为不需要读取变量的值</p><p>:::</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> putServiceLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token doc-comment comment">/**
     * Put service into manager.
     *
     * <span class="token keyword">@param</span> <span class="token parameter">service</span> service
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putService</span><span class="token punctuation">(</span><span class="token class-name">Service</span> service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果不存在该 namespace，创建</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serviceMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>putServiceLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serviceMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    serviceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentSkipListMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        serviceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="rest接口" tabindex="-1"><a class="header-anchor" href="#rest接口" aria-hidden="true">#</a> Rest接口</h3><p><a href="https://nacos.io/zh-cn/docs/open-api.html" target="_blank" rel="noopener noreferrer">Open API 指南 (nacos.io)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="分布式" tabindex="-1"><a class="header-anchor" href="#分布式" aria-hidden="true">#</a> 分布式</h2><h3 id="一致性协议" tabindex="-1"><a class="header-anchor" href="#一致性协议" aria-hidden="true">#</a> 一致性协议</h3><p>Nacos提供CP和AP两类实现，CP使用现有库的Raft协议实现，AP使用自研弱一致性Distro协议</p><h3 id="todo-distro" tabindex="-1"><a class="header-anchor" href="#todo-distro" aria-hidden="true">#</a> todo：distro</h3><h2 id="参考" tabindex="-1"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h2><p><a href="https://blog.csdn.net/chongbaozhong/article/details/116658595" target="_blank" rel="noopener noreferrer">Nacos 1.4.1源码启动流程_nacos 1.4.1 源码启动_苏州-DaniR的博客-CSDN博客<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://nacos.io/zh-cn/docs/quick-start.html" target="_blank" rel="noopener noreferrer">Nacos 快速开始<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>https://developer.aliyun.com/ebook/36</p><p><a href="https://blog.csdn.net/weixin_37689658/article/details/122626747" target="_blank" rel="noopener noreferrer">Nacos集群（二）阿里自研弱一致性Distro协议核心实现_@candistro_我神级欧文的博客-CSDN博客<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/xiaoso456/notes/edit/main/docs/Java/源码阅读/nacos.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页"><!--[--><!--]--> 编辑此页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">最后更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: xiaoso456@qq.com">xiaoso</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/notes/assets/app-9157d7b3.js" defer></script>
  </body>
</html>
